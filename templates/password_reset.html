{% extends "base.html" %}
{% block title %}Восстановление пароля — Courier Sim{% endblock %}
{% block content %}
<div class="bg-gr4" style="width: 100%; height: 100vh; display: flex; align-items: flex-end; justify-content:center; padding-bottom: 24px; overflow-y: hidden; padding-left: 16px; padding-right: 16px;">


  <!--Modal-->
  <div class="login-modal-content" style="z-index: 1;">

    <span class="modal_header" style="gap: 8px; justify-content: space-between; padding: 0px !important; margin-bottom: 24px;">

      <h2 class="black100">Восстановление</h2>
      <!-- Кнопка закрытия -->
      <a href="/" class="icon_button graybg">
        <img src="{{ url_for('static', filename='img/icon/cross.svg') }}" alt="Close" style="width: 24px; height: 24px;">
      </a>

    </span>
    
    <!-- ШАГ 1: Отправка кода на email -->
    <form id="sendResetCodeForm">
      <div style="margin-bottom: 12x;">
        <input 
          type="email" 
          id="email" 
          name="email"
          placeholder="Ваш email"
          required

        >
        <p class="black100" style="margin-top: 12px; margin-bottom: 24px;">
          Отправим код восстановления на вашу почту
        </p>
      </div>
      
      <button 
        type="submit" 
        class="action_button"
        style="width: 100%; margin-top: 8px;"
      >
        <h3 class="white100">Отправить код</h3>
      </button>
    </form>
    
    <!-- ШАГ 2: Ввод кода и нового пароля (скрыт по умолчанию) -->
    <form id="resetPasswordForm" style="display: none;">
      

      <!-- E-mail Message-->
      <div class="positive_message" style="margin-bottom: 8px;">

        <span class="hstack gap8">

          <img src="{{ url_for('static', filename='img/icon/mail.svg') }}" alt="mail" style="width: 24px; height: 24px;">
          <p class="positive100">Код отправлен на <strong id="sentEmail"></strong></p>

        </span>

      </div>


      
      <div style="margin-bottom: 16px;">
        <input 
          type="text" 
          id="code" 
          name="code"
          placeholder="Введите 6-значный код"
          maxlength="6"
          required
        >
      </div>
      
      <div style="margin-bottom: 8px;">
        <input 
          type="password" 
          id="new_password" 
          name="new_password"
          placeholder="Новый пароль"
          required
        >
      </div>
      
      <div style="margin-bottom: 24px;">
        <input 
          type="password" 
          id="confirm_password" 
          name="confirm_password"
          placeholder="Введите  новый пароль ещё раз"
          required
        >
      </div>
      
      <button 
        type="submit" 
        class="action_button"
        style="margin-top: 8px; margin-bottom: 4px;"
      >
        <h3 class="white100">Сбросить пароль</h3>
      </button>
      
      <button 
        type="button"
        id="backButton"
        class="secondary_button"
      >
        Изменить email
      </button>
    </form>
    
  </div>

  <img src="/static/img/landing/landing-hero.png" alt="hero" style="position: fixed; width: 100%; margin-bottom: 300px;">
</div>

<script>
let currentEmail = '';

// ШАГ 1: Отправка кода восстановления
document.getElementById('sendResetCodeForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const email = document.getElementById('email').value.trim();
  const button = e.target.querySelector('button');
  const buttonText = button.querySelector('h3');
  
  if (!email) {
    alert('Введите email');
    return;
  }
  
  // Блокируем кнопку
  button.disabled = true;
  buttonText.textContent = 'Отправка...';
  
  try {
    const response = await fetch('/api/auth/password-reset/send-code', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ email: email })
    });
    
    const data = await response.json();
    
    if (response.ok && data.success) {
      // Сохраняем email
      currentEmail = email;
      
      // Показываем форму ввода кода
      document.getElementById('sendResetCodeForm').style.display = 'none';
      document.getElementById('resetPasswordForm').style.display = 'block';
      document.getElementById('sentEmail').textContent = email;
      
      // Фокус на поле кода
      document.getElementById('code').focus();
    } else {
      alert('Ошибка: ' + (data.error || 'Не удалось отправить код'));
      button.disabled = false;
      buttonText.textContent = 'Отправить код';
    }
  } catch (error) {
    console.error('Send reset code error:', error);
    alert('Ошибка соединения с сервером');
    button.disabled = false;
    buttonText.textContent = 'Отправить код';
  }
});

// ШАГ 2: Сброс пароля
document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const code = document.getElementById('code').value.trim();
  const newPassword = document.getElementById('new_password').value;
  const confirmPassword = document.getElementById('confirm_password').value;
  const button = e.target.querySelector('button[type="submit"]');
  const buttonText = button.querySelector('h3');
  
  // Валидация
  if (!code || !newPassword || !confirmPassword) {
    alert('Заполните все поля');
    return;
  }
  
  if (code.length !== 6) {
    alert('Код должен содержать 6 цифр');
    return;
  }
  
  if (newPassword.length < 6) {
    alert('Пароль должен содержать минимум 6 символов');
    return;
  }
  
  if (newPassword !== confirmPassword) {
    alert('Пароли не совпадают');
    return;
  }
  
  // Блокируем кнопку
  button.disabled = true;
  buttonText.textContent = 'Сброс...';
  
  try {
    const response = await fetch('/api/auth/password-reset/verify', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ 
        email: currentEmail,
        code: code,
        new_password: newPassword
      })
    });
    
    const data = await response.json();
    
    if (response.ok && data.success) {
      alert('✅ Пароль успешно изменён! Теперь вы можете войти с новым паролем.');
      window.location.href = '/login';
    } else {
      alert('Ошибка: ' + (data.error || 'Не удалось сбросить пароль'));
      button.disabled = false;
      buttonText.textContent = 'Сбросить пароль';
    }
  } catch (error) {
    console.error('Reset password error:', error);
    alert('Ошибка соединения с сервером');
    button.disabled = false;
    buttonText.textContent = 'Сбросить пароль';
  }
});

// Кнопка "Назад"
document.getElementById('backButton').addEventListener('click', () => {
  document.getElementById('resetPasswordForm').style.display = 'none';
  document.getElementById('sendResetCodeForm').style.display = 'block';
  
  // Очищаем поля
  document.getElementById('code').value = '';
  document.getElementById('new_password').value = '';
  document.getElementById('confirm_password').value = '';
  
  // Разблокируем кнопку
  const button = document.getElementById('sendResetCodeForm').querySelector('button');
  button.disabled = false;
  button.querySelector('h3').textContent = 'Отправить код';
});
</script>
{% endblock %}
